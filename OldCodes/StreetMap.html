<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map Example</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        header {
            background-image: url('headerFYP.png');
            /* Replace with your image path */
            background-size: cover;
            background-position: center;
            height: 50vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #EFF68B;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header-content {
            position: relative;
            z-index: 2;
            animation: fadeIn 2s ease-in-out;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: fit-content;
            font-family: "Poppins", sans-serif;
            background: #131E23;
        }

        .container {
            width: 90vw;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #131E23;
        }

        .container h1 {
            color: #EFF68B;
            font-size: 7vw;
            text-align: center;
            margin: 5px;
        }

        .container p {
            color: white;
            font-size: 3.2vw;
            text-align: center;
            margin: 5px;
        }

        .button-group {
            text-align: center;
            margin-bottom: 20px;
        }

        .button-group button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .dropdown-group {
            text-align: center;
            margin-bottom: 20px;
        }

        .dropdown-group select {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #map {
            height: 70vh;
            width: 100%;
            border: 2px solid #333;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <h1>Navigation</h1>
        </div>
    </header>
    <div class="container">
        <h1>Welcome to the Map</h1>
        <p>This map shows different markers based on the selected level.</p>
        <div class="button-group">
            <button onclick="showLevel(1)">Level 1</button>
            <button onclick="showLevel(2)">Level 2</button>
            <button onclick="showLevel(3)">Level 3</button>
        </div>
        <div class="dropdown-group">
            <select id="marker2">
                <option value="">Select Destination</option>
            </select>
            <button onclick="navigate()">Navigate</button>
            <button onclick="showUserLocation()">Show My Location</button>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([3.07179, 101.49990], 70);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var customIcon1 = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png',
            iconSize: [4 * window.innerWidth / 100, 4 * window.innerHeight / 100], // 4vw x 4vh
        });

        var customIcon2 = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png',
            iconSize: [3 * window.innerWidth / 100, 3 * window.innerHeight / 100], // 3vw x 3vh
        });
        var road = L.icon({
            iconUrl: 'red_dot.png',
            iconSize: [2 * window.innerWidth / 100, 2 * window.innerHeight / 100], // 3vw x 3vh
        });

        // Declare each room marker individually
        var bk1 = { id: 'BK1', geocode: [(3.07159), (101.499970)], popUp: "BK1", icon: customIcon2 };
        var bk2 = { id: 'BK2', geocode: [(3.07153), (101.499935)], popUp: "BK2", icon: customIcon2 };
        var bk3 = { id: 'BK3', geocode: [(3.07150), (101.499880)], popUp: "BK3", icon: customIcon2 };
        var bk4 = { id: 'BK4', geocode: [(3.07145), (101.499750)], popUp: "BK4", icon: customIcon2 };
        var bk5 = { id: 'BK5', geocode: [(3.07140), (101.499770)], popUp: "BK5", icon: customIcon2 };
        var bk6 = { id: 'BK6', geocode: [(3.07135), (101.499820)], popUp: "BK6", icon: customIcon2 };
        var bk7 = { id: 'BK7', geocode: [(3.07127), (101.499890)], popUp: "BK7", icon: customIcon2 };
        var bk8 = { id: 'BK8', geocode: [(3.07118), (101.499970)], popUp: "BK8", icon: customIcon2 };
        var bk11 = { id: 'B11', geocode: [(3.07116), (101.500370)], popUp: "B11", icon: customIcon2 };
        var bk12 = { id: 'B12', geocode: [(3.07123), (101.500440)], popUp: "B12", icon: customIcon2 };
        var bk13 = { id: 'B13', geocode: [(3.07132), (101.500530)], popUp: "B13", icon: customIcon2 };
        var bk14 = { id: 'B14', geocode: [(3.07134), (101.500440)], popUp: "B14", icon: customIcon2 };
        var bk15 = { id: 'B15', geocode: [(3.07141), (101.500500)], popUp: "B15", icon: customIcon2 };
        var bk20 = { id: 'B20', geocode: [(3.07200), (101.499380)], popUp: "B20", icon: customIcon2 };
        var bk21 = { id: 'B21', geocode: [(3.07209), (101.499330)], popUp: "B21", icon: customIcon2 };
        var bk22 = { id: 'B22', geocode: [(3.07223), (101.499300)], popUp: "B22", icon: customIcon2 };
        var bk23 = { id: 'B23', geocode: [(3.07235), (101.499280)], popUp: "B23", icon: customIcon2 };
        var bk24 = { id: 'B24', geocode: [(3.07233), (101.499470)], popUp: "B24", icon: customIcon2, neighbours: ['r8'] };
        var bk25 = { id: 'B25', geocode: [(3.07223), (101.499490)], popUp: "B25", icon: customIcon2, neighbours: ['r8'] };
        var bk26 = { id: 'B26', geocode: [(3.07215), (101.499550)], popUp: "B26", icon: customIcon2, neighbours: ['r8'] };

        var bk30 = { id: 'B30', geocode: [(3.07223), (101.49979)], popUp: "B30", icon: customIcon2,neighbours: ['r4'] };
        var bk31 = { id: 'B31', geocode: [(3.07236), (101.49971)], popUp: "B31", icon: customIcon2,neighbours: ['r4'] };
        var bk32 = { id: 'B32', geocode: [(3.07247), (101.49960)], popUp: "B32", icon: customIcon2,neighbours: ['r5'] };

        var r1 = { id: 'r1', geocode: [(3.07190), (101.49951)], icon: road, popUp: "1", neighbours: ['r2', 'r8'] };
        var r2 = { id: 'r2', geocode: [(3.07194), (101.49965)], icon: road, popUp: "2", neighbours: ['r1', 'r3'] };
        var r3 = { id: 'r3', geocode: [(3.07209), (101.49982)], icon: road, popUp: "3", neighbours: ['r2', 'r4'] };
        var r4 = { id: 'r4', geocode: [(3.07229), (101.49967)], icon: road, popUp: "4", neighbours: ['r3', 'r5','B31','B30'] };
        var r5 = { id: 'r5', geocode: [(3.07245), (101.49951)], icon: road, popUp: "5", neighbours: ['r4', 'r6','B32'] };
        var r6 = { id: 'r6', geocode: [(3.07254), (101.49940)], icon: road, popUp: "6", neighbours: ['r5', 'r7'] };
        var r7 = { id: 'r7', geocode: [(3.07239), (101.49937)], icon: road, popUp: "7", neighbours: ['r6', 'r8'] };
        var r8 = { id: 'r8', geocode: [(3.07215), (101.49941)], icon: road, popUp: "8", neighbours: ['r7', 'r1','B24'] };
        var r9 = { id: 'r9', geocode: [(3.07182), (101.49940)], icon: road, popUp: "9", neighbours: ['r8', 'r1','B24'] };
        var r10 = { id: 'r10', geocode: [(3.07194), (101.49972)], icon: road, popUp: "10", neighbours: ['r17', 'r1','B24'] };
        var r11 = { id: 'r11', geocode: [(3.07190), (101.49951)], icon: road, popUp: "11", neighbours: ['r12', 'r8'] };
        var r12 = { id: 'r12', geocode: [(3.07194), (101.49965)], icon: road, popUp: "12", neighbours: ['r11', 'r3'] };
        var r13 = { id: 'r13', geocode: [(3.07209), (101.49982)], icon: road, popUp: "13", neighbours: ['r12', 'r4'] };
        var r14 = { id: 'r14', geocode: [(3.07229), (101.49967)], icon: road, popUp: "14", neighbours: ['r13', 'r5','B31','B30'] };
        var r15 = { id: 'r15', geocode: [(3.07245), (101.49951)], icon: road, popUp: "15", neighbours: ['r14', 'r6','B32'] };
        var r16 = { id: 'r16', geocode: [(3.07254), (101.49940)], icon: road, popUp: "16", neighbours: ['r15', 'r7'] };
        var r17 = { id: 'r17', geocode: [(3.07239), (101.49937)], icon: road, popUp: "17", neighbours: ['r16', 'r8'] };
        var r18 = { id: 'r18', geocode: [(3.07215), (101.49941)], icon: road, popUp: "18", neighbours: ['r17', 'r1','B24'] };
        var r19 = { id: 'r19', geocode: [(3.07194), (101.49972)], icon: road, popUp: "19", neighbours: ['r18', 'r1','B24'] };
        var r20 = { id: 'r20', geocode: [(3.07194), (101.49972)], icon: road, popUp: "20", neighbours: ['r19', 'r1','B24'] };
        
        var level1Markers = [bk1, bk2, bk3, bk4, bk5, bk6, bk7, bk8, bk20, bk21, bk22, bk23, bk24, bk25, bk26,bk30,bk31,bk32];
        var level2Markers = [bk11, bk12, bk13, bk14, bk15];
        var level3Markers = [r1, r2, r3, r4, r5, r6, r7, r8,r9,r10,r11,r12,r13,r14];
        var awi = 0;
        var markers = L.layerGroup().addTo(map);
        var roadArray = [r1, r2, r3, r4, r5, r6, r7, r8,r9,r10,r11,r12,r13,r14];
        var lat = 0;
        var lng = 0;
        var polyline;
        var nearestMarkerlat = 0;
        var nearestMarkerlng = 0;
        var nearestMarkerID = '';
        var currentMarkers = [];
        var allMarkers = {
            'BK1': bk1,
            'BK2': bk2,
            'BK3': bk3,
            'BK4': bk4,
            'BK5': bk5,
            'BK6': bk6,
            'BK7': bk7,
            'BK8': bk8,
            'B11': bk11,
            'B12': bk12,
            'B13': bk13,
            'B14': bk14,
            'B15': bk15,
            'B20': bk20,
            'B21': bk21,
            'B22': bk22,
            'B23': bk23,
            'B24': bk24,
            'B25': bk25,
            'B26': bk26,
            'B30': bk30,
            'B31': bk31,
            'B32': bk32,
            'r1': r1,
            'r2': r2,
            'r3': r3,
            'r4': r4,
            'r5': r5,
            'r6': r6,
            'r7': r7,
            'r8': r8,
            'r9': r9,
            'r10':r10,
            'r11':r11,
        };
        var distances = {};
        var previous = {};
        var queue = [];

        function showLevel(level) {
            markers.clearLayers();
            var selectedMarkers = level === 1 ? level1Markers : level === 2 ? level2Markers : level3Markers;
            var dropdown = document.getElementById("marker2");
            dropdown.innerHTML = '<option value="">Select Destination</option>';
            selectedMarkers.forEach(function (marker) {
                L.marker([marker.geocode[0], marker.geocode[1]], { icon: marker.icon }).addTo(markers).bindPopup(marker.popUp);
                var option = document.createElement("option");
                option.value = marker.id;
                option.text = marker.popUp;
                dropdown.appendChild(option);
            });
        }
        function findNearestMarker(lat, lng, levelMarkers) {
            var nearestMarker = { id: '', geocode: [(0), (0)], popUp: "" };
            var ids;
            var nearestDistance = Infinity;
            levelMarkers.forEach(function (marker) {
                var distance = calculateDistance(lat, lng, marker.geocode[0], marker.geocode[1]);
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    ids = marker.id;
                }
            });
            return ids;
        }
        function findNearestMarkerlat(lat, lng, levelMarkers) {
            var nearestMarker = { geocode: [(0), (0)], popUp: "" };
            var geo1 = 0;
            var nearestDistance = Infinity;
            levelMarkers.forEach(function (marker) {
                var distance = calculateDistance(lat, lng, marker.geocode[0], marker.geocode[1]);
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    geo1 = marker.geocode[0];
                }
            });
            return geo1;
        }
        function findNearestMarkerlng(lat, lng, levelMarkers) {
            var nearestMarker = { geocode: [(0), (0)], popUp: "" };
            var geo2 = 0;
            var nearestDistance = Infinity;
            levelMarkers.forEach(function (marker) {
                var distance = calculateDistance(lat, lng, marker.geocode[0], marker.geocode[1]);
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    geo2 = marker.geocode[1];
                }
            });
            return geo2;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            function toRadians(degrees) {
                return degrees * Math.PI / 180;
            }

            var R = 6371e3; // Radius of the Earth in meters
            var phi1 = toRadians(lat1);
            var phi2 = toRadians(lat2);
            var deltaPhi = toRadians(lat2 - lat1);
            var deltaLambda = toRadians(lon1 - lon2); // Correcting the order here

            var a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                Math.cos(phi1) * Math.cos(phi2) *
                Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        function dijkstra(start, end, graph) {
            var distances = {};
            var previous = {};
            var pq = new PriorityQueue();

            for (var node in graph) {
                distances[node] = Infinity;
                previous[node] = null;
            }

            distances[start.id] = 0;
            pq.enqueue(start.id, 0);

            while (!pq.isEmpty()) {
                var current = pq.dequeue().element;

                if (current === end.id) break;

                var neighbors = graph[current].neighbours;
                for (var neighbor of neighbors) {
                    var distance = distances[current] + calculateDistance(
                        graph[current].geocode[0],
                        graph[current].geocode[1],
                        graph[neighbor].geocode[0],
                        graph[neighbor].geocode[1]
                    );

                    if (distance < distances[neighbor]) {
                        distances[neighbor] = distance;
                        previous[neighbor] = current;
                        pq.enqueue(neighbor, distance);
                    }
                }
            }

            var path = [];
            var at = end.id;
            while (at !== null) {
                path.unshift(graph[at]);
                at = previous[at];
            }

            return path;
        }

        function navigate() {
            var selectedMarkerId = document.getElementById('marker2').value;
            var selMark = allMarkers[selectedMarkerId];
            var end = allMarkers[selectedMarkerId];

            navigator.geolocation.getCurrentPosition(function (position) {
                lat = position.coords.latitude;
                lng = position.coords.longitude;
                nearestMarkerlat = findNearestMarkerlat(lat, lng, roadArray);
                nearestMarkerlng = findNearestMarkerlng(lat, lng, roadArray);
                nearestMarkerID = findNearestMarker(lat, lng, roadArray);
                var start = allMarkers[nearestMarkerID];

                if (polyline) {
                    map.removeLayer(polyline);
                }

                map.setView([lat, lng], 70);
                var userMarker = L.marker([lat, lng], { icon: customIcon2 }).addTo(map).bindPopup("You are here " + end.popUp).openPopup();
                var polylinePoints = [
                    [lat, lng],
                    [nearestMarkerlat, nearestMarkerlng],
                ];

                var path = dijkstra(start, end, allMarkers);

                path.forEach(function (road) {
                    polylinePoints.push(road.geocode);
                });

                polyline = L.polyline(polylinePoints, { color: 'blue' }).addTo(map);
                map.fitBounds(polyline.getBounds());
            });
        }

        // Priority Queue implementation
        function PriorityQueue() {
            this.collection = [];
        }

        PriorityQueue.prototype.enqueue = function (element, priority) {
            var queueElement = { element, priority };
            var added = false;

            for (var i = 0; i < this.collection.length; i++) {
                if (queueElement.priority < this.collection[i].priority) {
                    this.collection.splice(i, 0, queueElement);
                    added = true;
                    break;
                }
            }

            if (!added) {
                this.collection.push(queueElement);
            }
        };

        PriorityQueue.prototype.dequeue = function () {
            return this.collection.shift();
        };

        PriorityQueue.prototype.isEmpty = function () {
            return this.collection.length === 0;
        };


        // Modified showUserLocation function
        function showUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    lat = position.coords.latitude;
                    lng = position.coords.longitude;
                    map.setView([lat, lng], 70);
                    var userMarker = L.marker([lat, lng], { icon: customIcon2 }).addTo(map).bindPopup("You are here").openPopup();
                })
            };
        }
        // Show Level 1 markers by default
        showLevel(3);
    </script>
</body>

</html>