<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map Example</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        header {
          background-image: url('headerFYP.png'); /* Replace with your image path */
          background-size: cover;
          background-position: center;
          height: 50vh;
          display: flex;
          justify-content: center;
          align-items: center;
          color: #EFF68B;
          text-align: center;
          position: relative;
          overflow: hidden;
        }
        
        .header-content {
          position: relative;
          z-index: 2;
          animation: fadeIn 2s ease-in-out;
        }
        
        header::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 1;
        }
        body, html {
          margin: 0;
          padding: 0;
          height: fit-content;
          font-family: "Poppins", sans-serif;
          background: #131E23;
        }
        .container {
            width: 90vw;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #131E23;
        }
        .container h1 {
            color:#EFF68B;
            font-size: 7vw;
            text-align: center;
            margin: 5px;
        }
        .container p{
            color:white;
            font-size: 3.2vw;
            text-align: center;
            margin: 5px;
        }

        .button-group {
            text-align: center;
            margin-bottom: 20px;
        }
        .button-group button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .dropdown-group {
            text-align: center;
            margin-bottom: 20px;
        }
        .dropdown-group select {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #map {
            height: 70vh;
            width: 100%;
            border: 2px solid #333;
            border-radius: 8px;
        }
    </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Navigation</h1>
    </div>
  </header>
  <div class="container">
    <h1>Welcome to the Map</h1>
    <p>This map shows different markers based on the selected level.</p>
    <div class="button-group">
        <button onclick="showLevel(1)">Level 1</button>
        <button onclick="showLevel(2)">Level 2</button>
        <button onclick="showLevel(3)">Level 3</button>
    </div>
    <div class="dropdown-group">
        <select id="marker2">
            <option value="">Select Destination</option>
        </select>
        <button onclick="navigate()">Navigate</button>
        <button onclick="showUserLocation()">Show My Location</button>
    </div>    
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([3.07179, 101.49990], 70);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var customIcon1 = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png',
        iconSize: [4 * window.innerWidth / 100, 4 * window.innerHeight / 100], // 4vw x 4vh
    });

    var customIcon2 = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/447/447031.png',
        iconSize: [3 * window.innerWidth / 100, 3 * window.innerHeight / 100], // 3vw x 3vh
    });

    function transCoodX(coordinate) {
        return coordinate.toString().slice(3, 7);
    }
    function transCoodY(coordinate) {
        return coordinate.toString().slice(4, 10);
    }

    // Declare each room marker individually
    var bk1 = { id: 'BK1', geocode: [transCoodX(3.07159), transCoodY(101.499970)], popUp: "BK1", icon: customIcon2 };
    var bk2 = { id: 'BK2', geocode: [transCoodX(3.07153), transCoodY(101.499935)], popUp: "BK2", icon: customIcon2 };
    var bk3 = { id: 'BK3', geocode: [transCoodX(3.07150), transCoodY(101.499880)], popUp: "BK3", icon: customIcon2 };
    var bk4 = { id: 'BK4', geocode: [transCoodX(3.07145), transCoodY(101.499750)], popUp: "BK4", icon: customIcon2 };
    var bk5 = { id: 'BK5', geocode: [transCoodX(3.07140), transCoodY(101.499770)], popUp: "BK5", icon: customIcon2 };
    var bk6 = { id: 'BK6', geocode: [transCoodX(3.07135), transCoodY(101.499820)], popUp: "BK6", icon: customIcon2 };
    var bk7 = { id: 'BK7', geocode: [transCoodX(3.07127), transCoodY(101.499890)], popUp: "BK7", icon: customIcon2 };
    var bk8 = { id: 'BK8', geocode: [transCoodX(3.07118), transCoodY(101.499970)], popUp: "BK8", icon: customIcon2 };
    var bk11 = { id: 'B11', geocode: [transCoodX(3.07116), transCoodY(101.500370)], popUp: "B11", icon: customIcon2 };
    var bk12 = { id: 'B12', geocode: [transCoodX(3.07123), transCoodY(101.500440)], popUp: "B12", icon: customIcon2 };
    var bk13 = { id: 'B13', geocode: [transCoodX(3.07132), transCoodY(101.500530)], popUp: "B13", icon: customIcon2 };
    var bk14 = { id: 'B14', geocode: [transCoodX(3.07134), transCoodY(101.500440)], popUp: "B14", icon: customIcon2 };
    var bk15 = { id: 'B15', geocode: [transCoodX(3.07141), transCoodY(101.500500)], popUp: "B15", icon: customIcon2 };
    var bk20 = { id: 'B20', geocode: [transCoodX(3.07200), transCoodY(101.499380)], popUp: "B20", icon: customIcon2 };
    var bk21 = { id: 'B21', geocode: [transCoodX(3.07209), transCoodY(101.499330)], popUp: "B21", icon: customIcon2 };
    var bk22 = { id: 'B22', geocode: [transCoodX(3.07223), transCoodY(101.499300)], popUp: "B22", icon: customIcon2 };
    var bk23 = { id: 'B23', geocode: [transCoodX(3.07235), transCoodY(101.499280)], popUp: "B23", icon: customIcon2 };
    var bk24 = { id: 'B24', geocode: [transCoodX(3.07233), transCoodY(101.499470)], popUp: "B24", icon: customIcon2 };
    var bk25 = { id: 'B25', geocode: [transCoodX(3.07223), transCoodY(101.499490)], popUp: "B25", icon: customIcon2 };
    var bk26 = { id: 'B26', geocode: [transCoodX(3.07215), transCoodY(101.499550)], popUp: "B26", icon: customIcon2 };

    var r1 = { id: 'R1', geocode: [transCoodX(3.07219), transCoodY(101.499550)], icon: customIcon2, neighbours: ['r2'] };
    var r2 = { id: 'R2', geocode: [transCoodX(3.07219), transCoodY(101.499550)], icon: customIcon2, neighbours: ['r1'] };

    var level1Markers = [bk1, bk2, bk3, bk4, bk5, bk6, bk7, bk8,bk20, bk21, bk22, bk23, bk24, bk25, bk26];
    var level2Markers = [bk11, bk12, bk13, bk14, bk15];
    var level3Markers = [r1,r2];
    var awi=0;
    var markers = L.layerGroup().addTo(map);
    var roadArray = [bk1, bk2, bk3, bk4, bk5, bk6, bk7, bk8,bk11, bk12, bk13, bk14, bk15,bk20, bk21, bk22, bk23, bk24, bk25, bk26];

    function showLevel(level) {
        markers.clearLayers();
        var selectedMarkers = level === 1 ? level1Markers : level === 2 ? level2Markers : level3Markers;
        var dropdown = document.getElementById("marker2");
        dropdown.innerHTML = '<option value="">Select Destination</option>';
        selectedMarkers.forEach(function(marker) {
            var transformedLat = parseFloat('3.0' + marker.geocode[0]);
            var transformedLng = parseFloat('101.' + marker.geocode[1]);
            L.marker([transformedLat, transformedLng], { icon: marker.icon }).addTo(markers).bindPopup(marker.popUp);
            var option = document.createElement("option");
            option.value = marker.id;
            option.text = marker.popUp;
            dropdown.appendChild(option);
        });
    }

    function setNeighbours(markers, threshold = 0.0001) {
    markers.forEach(marker => {
        marker.neighbours = markers.filter(neighbour => {
            if (marker.id !== neighbour.id) {
                var markerLat = parseFloat('3.0' + marker.geocode[0]);
                var markerLng = parseFloat('101.' + marker.geocode[1]);
                var neighbourLat = parseFloat('3.0' + neighbour.geocode[0]);
                var neighbourLng = parseFloat('101.' + neighbour.geocode[1]);
                return calculateDistance(markerLat, markerLng, neighbourLat, neighbourLng) < threshold;
            }
            return false;
        });
    });
}

function dijkstra(start, end, roads) {
    var distances = {};
    var previous = {};
    var queue = new PriorityQueue((a, b) => distances[a.id] - distances[b.id]);

    roads.forEach(road => {
        distances[road.id] = Infinity;
        previous[road.id] = null;
        queue.enqueue(road);
    });

    distances[start.id] = 0;

    while (!queue.isEmpty()) {
        var current = queue.dequeue();
        if (current.id === end.id) {
            var path = [];
            var temp = current;
            while (previous[temp.id]) {
                path.push(temp);
                temp = previous[temp.id];
            }
            return path.reverse();
        }

        current.neighbours.forEach(neighbour => {
            var alt = distances[current.id] + calculateDistance(
                parseFloat('3.0' + current.geocode[0]),
                parseFloat('101.' + current.geocode[1]),
                parseFloat('3.0' + neighbour.geocode[0]),
                parseFloat('101.' + neighbour.geocode[1])
            );
            if (alt < distances[neighbour.id]) {
                distances[neighbour.id] = alt;
                previous[neighbour.id] = current;
                queue.enqueue(neighbour);
            }
        });
    }
    return [];
}

    function calculateDistance(lat1, lon1, lat2, lon2) {
    function toRadians(degrees) {
        return degrees * Math.PI / 180;
    }

    var R = 6371e3; // Radius of the Earth in meters
    var phi1 = toRadians(lat1);
    var phi2 = toRadians(lat2);
    var deltaPhi = toRadians(lat2 - lat1);
    var deltaLambda = toRadians(lon2 - lon1);

    var a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
            Math.cos(phi1) * Math.cos(phi2) *
            Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    var distance = R * c;
    return distance;
}

function findNearestMarker(lat, lng, levelMarkers) {
    var nearestMarker = null;
    var nearestDistance = Infinity;
    levelMarkers.forEach(function(marker) {
        var transformedLat = parseFloat('3.0' + marker.geocode[0]);
        var transformedLng = parseFloat('101.' + marker.geocode[1]);
        var distance = calculateDistance(lat, lng, transformedLat, transformedLng);
        if (distance < nearestDistance) {
            nearestDistance = distance;
            nearestMarker = marker;
        }
    });
    return nearestMarker;
}

function findNearestRoadMarker(lat, lng, roadMarkers) {
    var nearestMarker = null;
    var nearestDistance = Infinity;
    roadMarkers.forEach(function(marker) {
        var transformedLat = parseFloat('3.0' + marker.geocode[0]);
        var transformedLng = parseFloat('101.' + marker.geocode[1]);
        var distance = calculateDistance(lat, lng, transformedLat, transformedLng);
        if (distance < nearestDistance) {
            nearestDistance = distance;
            nearestMarker = marker;
        }
    });
    return nearestMarker;
}

function showUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var nearestMarker = findNearestMarker(lat, lng, level1Markers.concat(level2Markers, level3Markers));
            var transformedLat = parseFloat('3.0' + nearestMarker.geocode[0]);
            var transformedLng = parseFloat('101.' + nearestMarker.geocode[1]);
            map.setView([transformedLat, transformedLng], 70);
            L.marker([lat, lng], { icon: customIcon1 }).addTo(map).bindPopup("You are here. Nearest marker: " + nearestMarker.popUp).openPopup();
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}
setNeighbours(roadArray);
function navigate() {
    var dropdown = document.getElementById("marker2");
    var selectedMarkerId = dropdown.value;
    if (!selectedMarkerId) {
        alert("Please select a destination.");
        return;
    }
    var selectedMarker = level1Markers.concat(level2Markers, level3Markers).find(marker => marker.id === selectedMarkerId);
    if (!selectedMarker) {
        alert("Selected marker not found.");
        return;
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;

            var startMarker = findNearestRoadMarker(lat, lng, roadArray);
            setNeighbours(roadArray);
            var path = dijkstra(startMarker, selectedMarker, roadArray);

            if (path.length === 0) {
                alert("No path found.");
                return;
            }

            var polylinePoints = path.map(marker => {
                var transformedLat = parseFloat('3.0' + marker.geocode[0]);
                var transformedLng = parseFloat('101.' + marker.geocode[1]);
                return [transformedLat, transformedLng];
            });

            polylinePoints.unshift([lat, lng]);
            polylinePoints.push([
                parseFloat('3.0' + selectedMarker.geocode[0]),
                parseFloat('101.' + selectedMarker.geocode[1])
            ]);

            map.setView([polylinePoints[0][0], polylinePoints[0][1]], 70);
            L.marker([lat, lng], { icon: customIcon1 }).addTo(map).bindPopup("You are here.");
            L.marker([
                parseFloat('3.0' + selectedMarker.geocode[0]),
                parseFloat('101.' + selectedMarker.geocode[1])
            ], { icon: customIcon2 }).addTo(map).bindPopup(selectedMarker.popUp).openPopup();

            var polyline = L.polyline(polylinePoints, { color: 'blue' }).addTo(map);
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}

class PriorityQueue {
    constructor(comparator = (a, b) => a - b) {
        this._heap = [];
        this._comparator = comparator;
    }
    size() {
        return this._heap.length;
    }
    isEmpty() {
        return this.size() === 0;
    }
    peek() {
        return this._heap[0];
    }
    enqueue(value) {
        this._heap.push(value);
        this._siftUp();
        return this.size();
    }
    dequeue() {
        const poppedValue = this.peek();
        const bottom = this.size() - 1;
        if (bottom > 0) {
            this._swap(0, bottom);
        }
        this._heap.pop();
        this._siftDown();
        return poppedValue;
    }
    _greater(i, j) {
        return this._comparator(this._heap[i], this._heap[j]) < 0;
    }
    _swap(i, j) {
        [this._heap[i], this._heap[j]] = [this._heap[j], this._heap[i]];
    }
    _siftUp() {
        let node = this.size() - 1;
        while (node > 0 && this._greater(node, Math.floor((node - 1) / 2))) {
            this._swap(node, Math.floor((node - 1) / 2));
            node = Math.floor((node - 1) / 2);
        }
    }
    _siftDown() {
        let node = 0;
        while (
            (node * 2 + 1 < this.size() && this._greater(node * 2 + 1, node)) ||
            (node * 2 + 2 < this.size() && this._greater(node * 2 + 2, node))
        ) {
            let maxChild = (node * 2 + 2 < this.size() && this._greater(node * 2 + 2, node * 2 + 1))
                ? node * 2 + 2
                : node * 2 + 1;
            this._swap(node, maxChild);
            node = maxChild;
        }
    }
}

    // Show Level 1 markers by default
    showLevel(1);
</script>
</body>
</html>
